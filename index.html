<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIアンビエント臨床記録デモ</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #rec-toolbar button { padding: 6px 10px; }
  textarea { width: 100%; }
</style>
</head>
<body>
<h1>AIアンビエント臨床記録デモ</h1>
<div>
  <label>医師と患者の会話:</label>
  <textarea id="conversation" rows="6"></textarea>
</div>
<div style="margin-top:10px;">
  <button onclick="generateRecord()">カルテを生成</button>
</div>
<div id="record-output" style="margin-top:20px; border:1px solid #ccc; padding:10px; white-space:pre-wrap;"></div>

<!-- 録音UI -->
<div id="rec-toolbar" style="margin-top:20px; display:flex; gap:8px; align-items:center;">
  <button id="startRec">録音開始</button>
  <button id="stopRec" disabled>録音停止</button>
  <button id="downloadRec" disabled>録音をダウンロード</button>
  <button id="uploadRec" disabled>サーバーへアップロード</button>
  <label style="margin-left:12px;font-size:13px;">文字起こし:
    <input type="checkbox" id="enableSTT" /> 使用する
  </label>
</div>
<div id="rec-preview" style="margin-top:10px;">
  <audio id="audioPlayback" controls style="display:block;max-width:100%;"></audio>
  <div id="transcript" style="white-space:pre-wrap;margin-top:6px;color:#0f172a;"></div>
</div>

<script>
function generateRecord() {
  const conversation = document.getElementById('conversation').value;
  const record = `【自動生成カルテ】\n${conversation}`;
  document.getElementById('record-output').textContent = record;
}

let mediaRecorder;
let recordedChunks = [];
const startBtn = document.getElementById('startRec');
const stopBtn = document.getElementById('stopRec');
const downloadBtn = document.getElementById('downloadRec');
const uploadBtn = document.getElementById('uploadRec');
const audioEl = document.getElementById('audioPlayback');
const transcriptEl = document.getElementById('transcript');
const enableSTT = document.getElementById('enableSTT');

startBtn.addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      audioEl.src = URL.createObjectURL(blob);
      downloadBtn.disabled = false;
      uploadBtn.disabled = false;
    };

    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
    transcriptEl.textContent = '録音中…';

    if (enableSTT.checked && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SpeechRec();
      rec.lang = 'ja-JP';
      rec.interimResults = true;
      rec.continuous = true;
      rec.onresult = (ev) => {
        let finalTxt = '';
        let interim = '';
        for (let i = 0; i < ev.results.length; i++) {
          const res = ev.results[i];
          if (res.isFinal) finalTxt += res[0].transcript;
          else interim += res[0].transcript;
        }
        transcriptEl.textContent = finalTxt + (interim ? '\n(途中): ' + interim : '');
      };
      rec.onerror = (e) => { console.warn('STT error', e); };
      rec.start();
      mediaRecorder._speechRecognition = rec;
    } else {
      if (enableSTT.checked) transcriptEl.textContent = 'ブラウザの音声認識が利用できません（Chrome推奨）。';
    }

  } catch (err) {
    alert('マイクへのアクセスが必要です: ' + err.message);
  }
});

stopBtn.addEventListener('click', () => {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    transcriptEl.textContent += '\n[録音停止]';
    if (mediaRecorder._speechRecognition) {
      try { mediaRecorder._speechRecognition.stop(); } catch(e) {}
    }
  }
});

downloadBtn.addEventListener('click', () => {
  const blob = new Blob(recordedChunks, { type: 'audio/webm' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'recording_' + new Date().toISOString().replace(/[:.]/g,'-') + '.webm';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

uploadBtn.addEventListener('click', async () => {
  const blob = new Blob(recordedChunks, { type: 'audio/webm' });
  const fd = new FormData();
  fd.append('file', blob, 'recording.webm');
  try {
    const res = await fetch('/upload', { method: 'POST', body: fd });
    if (!res.ok) throw new Error('Upload failed: ' + res.status);
    const json = await res.json();
    alert('アップロード成功: ' + JSON.stringify(json));
  } catch (err) {
    alert('アップロード失敗: ' + err.message);
  }
});
</script>
</body>
</html>
